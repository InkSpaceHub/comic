<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Comic | INK SPACE</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS SAMA MACAM SEBELUM NI, CUMA TAMBAH STYLE UNTUK PAGES */
        :root { --bg-body: #050505; --accent: #ff6600; --text-main: #ffffff; }
        body { margin: 0; padding: 0; font-family: 'Roboto Condensed', sans-serif; background-color: var(--bg-body); color: var(--text-main); }
        
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 30px; background: rgba(5, 5, 5, 0.95); border-bottom: 2px solid var(--accent); position: sticky; top: 0; z-index: 999; }
        .logo { font-family: 'Teko', sans-serif; font-size: 1.8rem; color: #fff; text-decoration: none; }
        .logo span { color: var(--accent); }
        .nav-controls a { color: #ccc; margin-left: 20px; text-decoration: none; }

        .reader-toolbar { background: #111; padding: 10px; display: flex; justify-content: center; gap: 15px; border-bottom: 1px solid #333; }
        .chapter-select { background: #222; color: #fff; padding: 8px; border: 1px solid #444; border-radius: 4px; }
        .nav-btn { background: #222; color: #fff; border: 1px solid #444; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
        .nav-btn.disabled { opacity: 0.5; pointer-events: none; }

        /* AREA BACA */
        .reader-container { max-width: 800px; margin: 0 auto; background: #000; min-height: 100vh; }
        
        /* CLASS UNTUK SETIAP PAGE - PENTING! */
        .comic-page { 
            width: 100%; 
            display: block; /* Hilang gap */
            margin: 0; 
            padding: 0;
            border: none;
        }
        
        .loading-text { text-align: center; padding: 50px; color: #888; }
        .bottom-section { padding: 40px; text-align: center; }
        .big-next-btn { background: var(--accent); color: #000; padding: 15px 40px; font-family: 'Teko'; font-size: 1.5rem; text-decoration: none; display: inline-block; margin-top: 20px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="logo">INK<span>SPACE</span></a>
        <div class="nav-controls">
            <a href="index.html">Home</a>
        </div>
    </nav>

    <div class="reader-toolbar">
        <button class="nav-btn disabled" id="btnPrev">Prev</button>
        <select class="chapter-select" id="chapterSelect"><option>Loading...</option></select>
        <button class="nav-btn disabled" id="btnNext">Next</button>
    </div>

    <div class="reader-container" id="readerCanvas">
        <div style="padding: 40px 20px; text-align: center;">
            <h1 id="comicTitle" style="font-family: 'Teko'; font-size: 3rem; margin:0;">LOADING...</h1>
            <p id="comicEp" style="color: var(--accent); margin:0; font-size: 1.2rem;">...</p>
        </div>

        <div id="pagesContainer">
             <div class="loading-text">Loading Pages...</div>
        </div>
        
        <div class="bottom-section">
            <h3>End of Episode</h3>
            <a href="index.html" class="big-next-btn">BACK TO SERIES</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDqDvRp1IGmhC5_EtQ8I5lBBfkPOaUBR-A",
            authDomain: "inkspace-c9dca.firebaseapp.com",
            databaseURL: "https://inkspace-c9dca-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "inkspace-c9dca",
            storageBucket: "inkspace-c9dca.firebasestorage.app",
            messagingSenderId: "92054275710",
            appId: "1:92054275710:web:b5e13736d46d7143307a2f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const targetTitle = urlParams.get('title');
        const targetEp = urlParams.get('ep');

        const titleEl = document.getElementById('comicTitle');
        const epEl = document.getElementById('comicEp');
        const pagesContainer = document.getElementById('pagesContainer');
        const selectBox = document.getElementById('chapterSelect');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');

        if(targetTitle && targetEp) {
            titleEl.innerText = targetTitle.toUpperCase();
            epEl.innerText = targetEp;

            onValue(ref(db, 'series'), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    let foundSeries = null;
                    Object.keys(data).forEach(key => {
                        if(data[key].title === targetTitle) foundSeries = data[key];
                    });

                    if (foundSeries && foundSeries.episodes) {
                        // Kumpul semua episod
                        const allEps = [];
                        let currentEpData = null;

                        Object.keys(foundSeries.episodes).forEach(epKey => {
                            const ep = foundSeries.episodes[epKey];
                            allEps.push(ep);
                            if(ep.name === targetEp) currentEpData = ep;
                        });

                        // 1. RENDER PAGES (LOOPING 18 PAGE)
                        if(currentEpData) {
                            pagesContainer.innerHTML = ""; // Kosongkan
                            
                            // Check: Adakah ia array (format baru) atau string (format lama)?
                            if(Array.isArray(currentEpData.pages)) {
                                // FORMAT BARU (Banyak Page)
                                currentEpData.pages.forEach(pageSrc => {
                                    const img = document.createElement('img');
                                    img.src = pageSrc;
                                    img.className = "comic-page";
                                    img.loading = "lazy"; // Supaya tak berat
                                    pagesContainer.appendChild(img);
                                });
                            } else if (currentEpData.img) {
                                // FALLBACK FORMAT LAMA (1 Page)
                                pagesContainer.innerHTML = `<img src="${currentEpData.img}" class="comic-page">`;
                            }
                        } else {
                            pagesContainer.innerHTML = "<div class='loading-text'>Episode not found.</div>";
                        }

                        // 2. SETUP NAVIGASI
                        allEps.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
                        selectBox.innerHTML = "";
                        const currentIndex = allEps.findIndex(e => e.name === targetEp);

                        allEps.forEach(ep => {
                            const isSelected = (ep.name === targetEp) ? "selected" : "";
                            const url = `read.html?title=${encodeURIComponent(targetTitle)}&ep=${encodeURIComponent(ep.name)}`;
                            selectBox.innerHTML += `<option value="${url}" ${isSelected}>${ep.name}</option>`;
                        });

                        btnPrev.classList.toggle('disabled', currentIndex <= 0);
                        if(currentIndex > 0) {
                            btnPrev.onclick = () => location.href = `read.html?title=${encodeURIComponent(targetTitle)}&ep=${encodeURIComponent(allEps[currentIndex-1].name)}`;
                        }

                        btnNext.classList.toggle('disabled', currentIndex >= allEps.length - 1);
                        if(currentIndex < allEps.length - 1) {
                            btnNext.onclick = () => location.href = `read.html?title=${encodeURIComponent(targetTitle)}&ep=${encodeURIComponent(allEps[currentIndex+1].name)}`;
                        }
                    }
                }
            });
        }

        selectBox.addEventListener('change', function() {
            if(this.value) window.location.href = this.value;
        });
    </script>
</body>
</html>
